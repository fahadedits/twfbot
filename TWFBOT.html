<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TWF Bot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <script
      src="https://kit.fontawesome.com/4c55db7417.js"
      crossorigin="anonymous"
    ></script>
    <style>
      /* --- General Styles for the Dark Theme --- */
      :root {
        --bg-dark: #070a13;
        --bg-card-start: #0f131a;
        --bg-card-end: #161b22;
        --accent-glow: #007bff;
        --accent: #5e17eb; /* Purple accent */
        --accent-light: #7b29f7; /* Lighter purple */
        --up: #10b981; /* Same as Tailwind's green-500 */
        --down: #ef4444; /* Same as Tailwind's red-500 */
        --martingale: #ffc107; /* Amber for Martingale */
        --muted: #9ca3af; /* Same as Tailwind's gray-400 */
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-dark);
        color: white;
      }

      /* Custom glow effect */
      .glow-border {
        position: relative;
        overflow: hidden;
        border: 2px solid transparent;
        border-radius: 14px;
        background: linear-gradient(var(--bg-card-start), var(--bg-card-end))
            padding-box,
          linear-gradient(to right, #7b29f7, #38bdf8, #7b29f7) border-box;
      }
      .glow-border::before {
        content: "";
        position: absolute;
        top: -1px;
        left: -1px;
        right: -1px;
        bottom: -1px;
        border-radius: 14px;
        background: radial-gradient(
          circle at center,
          rgba(94, 23, 235, 0.5),
          transparent 70%
        );
        z-index: -1;
        transition: opacity 0.3s ease;
        opacity: 0;
      }
      .glow-border:hover::before {
        opacity: 1;
      }
      .glow-border:active::before {
        opacity: 0.8;
        transform: scale(0.98);
      }

      /* Updated header and card styles with gradients */
      .top,
      .card,
      .panel {
        background: linear-gradient(
          135deg,
          var(--bg-card-start),
          var(--bg-card-end)
        );
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        position: relative;
        z-index: 1;
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }

      .card:hover,
      .panel:hover {
        border-color: rgba(94, 23, 235, 0.2);
        box-shadow: 0 0 25px rgba(94, 23, 235, 0.2);
      }

      .top {
        background: rgba(15, 19, 26, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: 0 0 20px rgba(94, 23, 235, 0.2);
        border: 2px solid rgba(94, 23, 235, 0.5);
      }

      /* Simple button style for a premium feel */
      .action-btn {
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 700;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 4px 15px rgba(94, 23, 235, 0.4);
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(94, 23, 235, 0.6);
      }

      .action-btn:active {
        transform: translateY(0);
        box-shadow: 2px 2px 10px rgba(94, 23, 235, 0.4);
      }

      /* Login Page specific styles */
      .login-card {
        padding: 1rem;
        border-radius: 12px;
        transition: all 0.3s ease;
      }
      .login-title {
        background: -webkit-linear-gradient(
          45deg,
          var(--accent-light),
          #38bdf8
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
      }
      .login-input {
        background-color: #0d1117;
        border-color: rgba(94, 23, 235, 0.5);
        color: white;
      }
      .login-input:focus {
        border-color: var(--accent-light);
        box-shadow: 0 0 5px rgba(94, 23, 235, 0.6);
      }

      .top-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
      }
      @media (min-width: 640px) {
        .top-stats {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      .top-stat-item {
        background: linear-gradient(
          135deg,
          var(--bg-card-start),
          var(--bg-card-end)
        );
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 1rem;
      }

      .big-num {
        font-size: 2.5rem;
        font-weight: 800;
      }

      .muted {
        color: var(--muted);
        font-size: 0.875rem;
      }

      .grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr;
      }

      @media (min-width: 1024px) {
        .grid {
          grid-template-columns: 2fr 1fr;
        }
      }

      .signals-empty,
      .history-empty {
        background: linear-gradient(
          135deg,
          rgba(94, 23, 235, 0.1),
          rgba(60, 10, 160, 0.1)
        );
        border: 1px dashed rgba(94, 23, 235, 0.5);
        border-radius: 8px;
        color: #ddd;
        padding: 2rem;
        text-align: center;
      }

      .signals-list,
      .recent-trades-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .signal-row {
        background: linear-gradient(135deg, #1e293b, #2d3748);
        border: 1px solid #4b5563;
        padding: 1rem;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: transform 0.2s ease-in-out;
      }
      .signal-row:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(94, 23, 235, 0.2);
      }

      @media (min-width: 768px) {
        .signal-row {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }

      .signal-left,
      .signal-right {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }

      @media (min-width: 768px) {
        .signal-right {
          align-items: flex-end;
          text-align: right;
        }
      }

      .signal-pair {
        font-weight: 700;
        font-size: 1.25rem;
      }

      .signal-time {
        font-size: 0.875rem;
        color: var(--up); /* Changed from purple to green */
      }

      .signal-reasons {
        font-size: 0.75rem;
        color: var(--muted);
        max-width: 300px;
        line-height: 1.3;
      }

      .up {
        color: var(--up);
        font-weight: 700;
      }

      .down {
        color: var(--down);
        font-weight: 700;
      }

      .martingale {
        color: var(--martingale);
        font-weight: 700;
      }

      .countdown {
        font-size: 1.5rem;
        font-weight: 800;
        background: -webkit-linear-gradient(45deg, #7b29f7, #38bdf8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-variant-numeric: tabular-nums;
      }

      .loader {
        border-top-color: var(--accent);
        -webkit-animation: spin 1.5s linear infinite;
        animation: spin 1.5s linear infinite;
      }

      .progress-line {
        background: #4b5563;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--up), #a7f3d0);
        transition: width 0.5s ease-in-out;
      }

      .trading-pairs {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .pair-item {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.75rem;
        background: #1e293b;
        border-radius: 8px;
        border: 1px solid #4b5563;
        transition: transform 0.2s ease-in-out;
      }
      .pair-item:hover {
        transform: translateX(4px);
      }

      @media (min-width: 768px) {
        .pair-item {
          flex-direction: row;
          align-items: center;
        }
      }

      .pair-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .pair-badge {
        width: 40px;
        height: 40px;
        background: linear-gradient(45deg, #374151, #4b5563);
        border-radius: 6px;
        display: grid;
        place-content: center;
        font-weight: 700;
      }

      .pair-symbol {
        font-weight: 600;
      }

      .pair-price {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .pair-right.up {
        color: var(--up);
      }
      .pair-right.down {
        color: var(--down);
      }

      .footer {
        text-align: center;
        padding: 2rem 0;
        color: var(--muted);
        font-size: 0.875rem;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
      }
      .table th,
      .table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #374151;
      }
      .table th {
        color: var(--accent-light);
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 600;
      }

      .history-table-td-result .up {
        color: var(--up);
      }
      .history-table-td-result .down {
        color: var(--down);
      }
      .history-table-td-result .martingale {
        color: var(--martingale);
      }

      /* Custom styles for manual signal buttons */
      .result-btns {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .result-btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: bold;
        transition: all 0.2s ease-in-out;
        border: none;
      }
      .result-btn.win {
        background: #065f46;
        color: #d1fae5;
      }
      .result-btn.loss {
        background: #991b1b;
        color: #fee2e2;
      }
      .result-btn.martingale {
        background: #b45309;
        color: #fffbeb;
      }

      .result-btn:hover {
        transform: translateY(-2px);
      }
      .result-btn:active {
        transform: translateY(0);
      }

      /* Styles for the expandable history section */
      details > summary {
        list-style: none;
        cursor: pointer;
        padding: 1rem 0;
        position: relative;
      }
      details > summary::-webkit-details-marker {
        display: none;
      }
      details > summary:before {
        content: "‚ñº";
        position: absolute;
        right: 0;
        top: 1rem;
        transition: transform 0.2s ease-in-out;
      }
      details[open] > summary:before {
        transform: rotate(180deg);
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .iframe-container iframe {
        width: 100%;
        min-height: 400px;
        border-radius: 12px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* New styles for video background on login page */
      .video-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 0;
        filter: blur(10px) brightness(0.5);
      }

      /* Center loader for login */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #0d1117;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
      }

      #loading-spinner {
        width: 60px;
        height: 60px;
        border: 8px solid #38bdf8;
        border-top-color: #5e17eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
    </style>
  </head>
  <body
    class="bg-gray-950 text-white min-h-screen flex items-center justify-center p-4"
  >
    <!-- Video background for the login page -->
    <video
      id="video-background"
      class="video-bg"
      autoplay
      loop
      muted
      playsinline
      style="display: none"
    >
      <source
        src="https://assets.mixkit.co/videos/preview/mixkit-forex-chart-data-on-a-monitor-40090-large.mp4"
        type="video/mp4"
      />
      <source
        src="https://assets.mixkit.co/videos/preview/mixkit-stock-market-on-a-computer-screen-40087-large.mp4"
        type="video/mp4"
      />
      <source
        src="https://mixkit.co/videos/preview/mixkit-trading-graphs-on-a-monitor-screen-40085-large.mp4"
        type="video/mp4"
      />
      Your browser does not support the video tag.
    </video>

    <!-- Loading overlay -->
    <div id="loading-overlay" style="display: none">
      <div id="loading-spinner"></div>
    </div>

    <!-- The main application container -->
    <div id="app-container" class="w-full"></div>

    <script>
      // Global state for the application
      let currentView = "login";

      // --- ACCESS CODES ARE HERE ---
      const validCodes = ["TWFBOT", "TWFUSERACCES"]; // <-- You can edit these codes      // -----------------------------
      const GFORM_URL =
        "https://docs.google.com/forms/d/e/1FAIpQLScSCr3ILGDGMH31hEHt8TkiK2HgtDqNtEqrL74SFaQ-SWxIhw/viewform?embedded=true";

      // Render the login page HTML
      const renderLoginPage = () => {
        const container = document.getElementById("app-container");
        container.innerHTML = `
  <div class="login-card w-full max-w-sm mx-auto relative z-10 transition-all duration-500 fade-in">
      <h1 class="text-4xl login-title text-center mb-2">TWF Bot</h1>
      <p class="text-center text-lg text-white mb-8">Premium Trading Signals</p>
  
      <div class="flex justify-center items-center mb-8">
          <div class="flex-1 text-center">
              <div id="users-count" class="text-4xl font-extrabold text-white">0</div>
              <div class="text-gray-400 text-sm">Users</div>
          </div>
          <div class="h-16 w-px bg-gray-700 mx-4"></div>
          <div class="flex-1 text-center">
              <div id="signals-count" class="text-4xl font-extrabold text-white">0</div>
              <div class="text-gray-400 text-sm">Signals Today</div>
          </div>
          <div class="h-16 w-px bg-gray-700 mx-4"></div>
          <div class="flex-1 text-center">
              <div id="accuracy-count" class="text-4xl font-extrabold text-white">0</div>
              <div class="text-gray-400 text-sm">Accuracy</div>
          </div>
      </div>
  
      <form id="login-form" class="space-y-6">
          <div>
              <label for="accessCode" class="block text-sm font-medium text-gray-300">Access Code</label>
              <input
                  type="text"
                  id="accessCode"
                  name="accessCode"
                  required
                  placeholder="Enter your access code"
                  class="mt-1 block w-full px-4 py-3 rounded-lg login-input border focus:outline-none focus:ring-2 focus:ring-accent-light transition-colors duration-300"
              />
          </div>
          <button
              id="login-button"
              type="submit"
              class="w-full flex items-center justify-center action-btn"
          >
              Login
          </button>
      </form>
  
      <div id="message-text" class="mt-4 text-center text-sm font-medium"></div>
  
      <div class="mt-8 flex flex-col space-y-4">
          <button
              id="buy-access-button"
              class="w-full py-3 px-4 rounded-lg font-bold text-white transition-all duration-300 ease-in-out bg-green-500 hover:bg-green-600 hover:shadow-lg hover:shadow-green-500/20"
          >
              Buy Access
          </button>
          <a href="https://t.me/MysticFahad" target="_blank" class="text-sm text-center text-blue-400 hover:underline">
              Contact for a trial
          </a>
      </div>
  
      <div class="mt-8 text-center text-xs text-gray-500">
          <p>By logging in, you agree to our terms & conditions.</p>
      </div>
  </div>
  `;
        // Animate numbers for visual effect
        const animateNumber = (element, target, suffix = "") => {
          let current = 0;
          const increment = target / 200;
          const updateCount = () => {
            current += increment;
            if (current < target) {
              element.textContent = Math.round(current) + suffix;
              requestAnimationFrame(updateCount);
            } else {
              element.textContent = target + suffix;
            }
          };
          updateCount();
        };

        // Initialize animations and event listeners
        animateNumber(document.getElementById("users-count"), 29867);
        animateNumber(document.getElementById("signals-count"), 12867);
        animateNumber(document.getElementById("accuracy-count"), 93, "%");

        // Attach event listeners
        document
          .getElementById("login-form")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("buy-access-button")
          .addEventListener("click", () => {
            currentView = "payment";
            renderPage();
          });

        // Show video background
        document.getElementById("video-background").style.display = "block";
      };

      // Render the payment page HTML
      const renderPaymentPage = () => {
        // Hide video background
        document.getElementById("video-background").style.display = "none";

        const container = document.getElementById("app-container");
        container.innerHTML = `
  <div class="login-card w-full max-w-2xl mx-auto relative z-10 transition-all duration-500 fade-in">
      <h2 class="text-3xl font-extrabold text-center login-title mb-6">Complete Your Payment</h2>
  
      <div class="bg-gray-800 p-6 rounded-xl space-y-4 mb-6 glow-border">
          <p class="text-lg font-semibold text-center text-gray-200">
              Total Payment: <span class="text-green-400 font-bold">$10 USDT</span>
          </p>
          <p class="text-sm text-white text-center">
              Follow these steps to complete your payment and gain access:
          </p>
          <ul class="list-decimal list-inside text-white space-y-2">
              <li>Send the exact payment amount to the USDT (TRC20) address below.</li>
              <li>Once the payment is sent, send the payment screenshot to Telegram.</li>
              <li>Your access will be activated shortly after verification.</li>
          </ul>
      </div>
  
      <div class="bg-gray-800 p-6 rounded-xl mb-6 glow-border">
          <p class="text-center text-lg font-semibold text-gray-200 mb-4">Manual Crypto Payment</p>
          <div class="flex flex-col md:flex-row items-center justify-center md:justify-around gap-8 md:gap-4">
              <div class="w-48 max-w-full h-auto">
                  <img
                      id="qr-code"
                      alt="QR Code for USDT (TRC20) payment"
                      class="rounded-lg shadow-lg w-full h-auto"
                  />
              </div>
  
              <div class="w-full md:w-auto flex-1 flex flex-col justify-center items-center gap-4">
                  <div class="w-full flex flex-col items-center bg-gray-900 p-4 rounded-xl border border-gray-600">
                      <span class="text-xs text-white block mb-2">USDT (TRC20) Address:</span>
                      <span class="break-all font-mono text-base md:text-lg text-white text-center" id="usdt-address">TXBySQvphzqfQxMcM3Wmii5iET2qJEYrN1</span>
                  </div>
                  <button
                      id="copy-button"
                      class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg font-bold transition duration-300"
                      aria-label="Copy USDT address to clipboard"
                  >
                      COPY
                  </button>
                  <p id="copy-status" class="text-green-500 text-xs mt-2 text-center"></p>
              </div>
          </div>
      </div>
  
      <div class="mt-8 flex flex-col space-y-4">
          </button>
          <a
              href="https://t.me/MysticFahad"
              target="_blank"
              rel="noopener noreferrer"
              class="w-full flex items-center justify-center py-3 px-4 rounded-lg font-bold text-white transition-all duration-300 ease-in-out bg-blue-500 hover:bg-blue-600 hover:scale-[1.02] active:scale-[0.98]"
              aria-label="Contact support on Telegram"
          >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.262 9.539l-2.915 13.568c-.135.617-.492.766-.993.472l-4.137-3.033-2.029 1.956c-.221.21-.409.283-.758.118l-.513-.379c-.198-.146-.253-.357-.107-.552l2.482-2.399-5.024-3.693c-.645-.295-.658-.658.106-1.01l15.137-5.834c.594-.228 1.052.179.79.914l-2.012 9.24z"/>
              </svg>
              Contact Support on Telegram
          </a>
          <button
              id="back-to-login"
              class="text-accent-light hover:text-accent transition duration-300"
              aria-label="Go back to the login page"
          >
              &larr; Back to Login
          </button>
      </div>
  </div>
  `;
        // Set QR code and event listeners
        const usdtAddress = document.getElementById("usdt-address").textContent;
        document.getElementById(
          "qr-code"
        ).src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${usdtAddress}`;

        document.getElementById("copy-button").addEventListener("click", () => {
          const el = document.createElement("textarea");
          el.value = usdtAddress;
          document.body.appendChild(el);
          el.select();
          document.execCommand("copy");
          document.body.removeChild(el);
          const statusEl = document.getElementById("copy-status");
          statusEl.textContent = "Address copied!";
          setTimeout(() => (statusEl.textContent = ""), 2000);
        });

        document
          .getElementById("back-to-login")
          .addEventListener("click", () => {
            currentView = "login";
            renderPage();
          });

        document
          .getElementById("upload-button")
          .addEventListener("click", () => {
            window.open(GFORM_URL.replace("?embedded=true", ""), "_blank");
          });
      };

      // Render the bot's page HTML
      const renderBotPage = () => {
        // Hide video background
        document.getElementById("video-background").style.display = "none";
        const container = document.getElementById("app-container");
        container.innerHTML = `
  <div class="bot-body w-full">
      <div class="wrap">
          <header class="top flex flex-col md:flex-row justify-between items-center p-4 md:p-6 mb-4 md:mb-8 gap-4">
              <div class="brand flex items-center gap-4">
                  <div class="logo w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-700 text-white flex items-center justify-center rounded-lg font-extrabold text-xl shadow-lg">TWF</div>
                  <div>
                      <h1 class="text-2xl font-bold text-white">TWF Bot</h1>
                      <p class="text-sm text-gray-400">Premium Trading Signals</p>
                  </div>
              </div>
  
              <div class="flex flex-col md:flex-row items-center gap-4">
                  <div class="flex items-center gap-2">
                      <i class="fas fa-clock text-accent-light text-xl"></i>
                      <div class="countdown" id="countdown">--:--</div>
                  </div>
                  <button id="toggle-view-btn" class="action-btn w-full md:w-auto">Switch to Manual Signals</button>
              </div>
          </header>
  
          <main class="grid lg:grid-cols-3 gap-4">
              <div class="main-panel lg:col-span-2 flex flex-col gap-4">
                  <div id="live-manual-container">
                      <section class="panel large p-4 md:p-6" id="livePanel">
                          <div class="flex justify-between items-center flex-wrap gap-2">
                              <div>
                                  <h2 class="text-xl font-semibold m-0 text-accent-light">Live Signals</h2>
                                  <div class="muted text-sm">Real-time generated signals</div>
                              </div>
                              <div class="flex items-center gap-2">
                                  <span class="text-green-500 font-bold text-sm">LIVE</span>
                                  <i class="fas fa-signal text-green-500"></i>
                              </div>
                          </div>
  
                          <div id="signalsArea" class="mt-4">
                              <div class="signals-empty" id="signalsEmpty">
                                  <div class="text-4xl mb-2">‚ö°</div>
                                  <div class="font-bold">No active signals at the moment</div>
                                  <div class="muted">Monitoring market conditions...</div>
                              </div>
                              <div class="signals-list" id="signalsList" style="display: none"></div>
                          </div>
  
                          <div class="mt-4 muted text-xs">
                              Note: Signals predict the next 1-minute candle.
                          </div>
                      </section>
                      <section class="panel p-4 md:p-6" id="manualPanel" style="display: none">
                          <div class="flex justify-between items-center flex-wrap gap-2">
                              <div>
                                  <h3 class="text-lg font-semibold m-0 text-accent-light">Manual Signals</h3>
                                  <div class="muted text-sm">
                                      Generate a single signal using the same live strategy
                                  </div>
                              </div>
                          </div>
  
                          <div class="mt-4 flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                              <select id="manualPair" class="input flex-grow bg-gray-800 text-white rounded-lg p-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-accent-light"></select>
                              <button id="genManual" class="action-btn w-full sm:w-auto">Generate Signal</button>
                          </div>
                          <div id="manualLoading" style="display: none" class="muted text-xs mt-2">
                              <i class="fas fa-spinner fa-spin mr-2"></i>Checking strategies‚Ä¶
                          </div>
  
                          <div id="manualResult" class="mt-4"></div>
                      </section>
                  </div>
                  <div class="top-stats">
                      <div class="card p-4 md:p-6 text-center">
                          <h3 class="text-sm font-bold text-accent-light uppercase">Total Signals</h3>
                          <div class="big-num text-accent-light mt-2" id="totalSignals">0</div>
                      </div>
                      <div class="card p-4 md:p-6 text-center">
                          <h3 class="text-sm font-bold text-accent-light uppercase">Win Rate</h3>
                          <div class="big-num text-green-500 mt-2" id="winRate">0.0%</div>
                      </div>
                      <div class="card p-4 md:p-6 text-center">
                          <h3 class="text-sm font-bold text-accent-light uppercase">Active Pairs</h3>
                          <div class="big-num text-indigo-400 mt-2" id="activePairs">10</div>
                      </div>
                  </div>
  
                  <section class="panel p-4 md:p-6" id="recentTradesPanel">
                      <h2 class="text-xl font-semibold m-0 text-accent-light">Recent Trades</h2>
                      <div class="muted text-sm mb-4">Select the result for recent signals</div>
                      <div id="recentTradesList" class="recent-trades-list"></div>
                      <div class="history-empty mt-4" id="recentTradesEmpty">
                          <div class="text-4xl mb-2">üéâ</div>
                          <div class="font-bold">No recent trades to resolve</div>
                          <div class="muted">Awaiting new signals...</div>
                      </div>
                  </section>
              </div>
              <div class="main-panel lg:col-span-1 flex flex-col gap-4">
                  <div class="card p-4 md:p-6">
                      <h4 class="text-lg font-bold text-white mb-4">Win/Loss Tracking</h4>
                      <div class="flex justify-between">
                          <div class="muted text-sm">Wins</div>
                          <div id="winsCount" class="font-bold text-green-500">0</div>
                      </div>
                      <div class="progress-line my-2">
                          <div id="winsFill" class="progress-fill" style="width: 0%"></div>
                      </div>
  
                      <div class="flex justify-between mt-4">
                          <div class="muted text-sm">Losses</div>
                          <div id="lossCount" class="font-bold text-red-500">0</div>
                      </div>
                      <div class="progress-line my-2">
                          <div id="lossFill" class="progress-fill" style="width: 0%; background: linear-gradient(90deg, var(--down), #ff9b9b);"></div>
                      </div>
  
                      <div class="flex justify-between mt-4">
                          <div class="muted text-sm">Total Accuracy</div>
                          <div class="font-extrabold text-lg text-accent-light" id="totalAcc">0.0%</div>
                      </div>
                  </div>
  
                  <div class="card p-4 md:p-6">
                      <h4 class="text-lg font-bold text-white mb-4">Trading Pairs</h4>
                      <div class="trading-pairs" id="pairsList" style="margin-top: 12px"></div>
                  </div>
              </div>
          </main>
  
          <section class="panel p-4 md:p-6 mt-4 md:mt-8" id="page-history">
              <details open>
                  <summary class="text-xl font-semibold m-0 text-accent-light mb-4">Trade History</summary>
                  <div class="overflow-x-auto">
                      <table class="table">
                          <thead>
                              <tr>
                                  <th class="text-sm">Time</th>
                                  <th class="text-sm">Pair</th>
                                  <th class="text-sm">Prediction</th>
                                  <th class="text-sm">Result</th>
                                  <th class="text-sm">Confidence</th>
                              </tr>
                          </thead>
                          <tbody id="historyTable"></tbody>
                      </table>
                  </div>
                  <div class="history-empty mt-4" id="historyEmpty">
                      No trades in history.
                  </div>
              </details>
          </section>
  
          <div class="footer">
              TWF Bot ‚Äî always test on demo accounts & long backtests before real trading.
          </div>
      </div>
  
      <div class="mt-8 w-full max-w-md mx-auto">
          <button id="logout-button" class="w-full flex items-center justify-center action-btn bg-red-600 hover:bg-red-700">
              Log Out
          </button>
      </div>
  </div>
  `;

        // Initialize bot dashboard functionality
        initializeBotDashboard();

        // Add event listener for the logout button
        document
          .getElementById("logout-button")
          .addEventListener("click", () => {
            currentView = "login";
            renderPage();
          });
      };

      // Main rendering function based on state
      const renderPage = () => {
        if (currentView === "login") {
          renderLoginPage();
        } else if (currentView === "payment") {
          renderPaymentPage();
        } else if (currentView === "bot") {
          renderBotPage();
        }
      };

      // Handle login form submission
      const handleLogin = (e) => {
        e.preventDefault();
        const accessCodeInput = document.getElementById("accessCode");
        const messageText = document.getElementById("message-text");
        const loginButton = document.getElementById("login-button");
        const accessCode = accessCodeInput.value.trim().toUpperCase();

        // Show loading state
        loginButton.innerHTML = `<div class="flex items-center justify-center"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6"></div></div>`;
        loginButton.disabled = true;
        messageText.textContent = "";

        setTimeout(() => {
          if (validCodes.includes(accessCode)) {
            // Show the loading overlay
            document.getElementById("loading-overlay").style.display = "flex";
            setTimeout(() => {
              // Hide the loading overlay and switch to bot view
              document.getElementById("loading-overlay").style.display = "none";
              currentView = "bot";
              renderPage();
            }, 2000); // 2-second delay for the loading animation
          } else {
            messageText.textContent = "Invalid access code. Please try again.";
            messageText.style.color = "#F87171"; // Tailwind's red-400
            loginButton.innerHTML = "Login";
            loginButton.disabled = false;
          }
        }, 1000); // Simulate a network delay
      };

      // Bot Dashboard Functions
      function initializeBotDashboard() {
        /* Config */
        const LIVE_PAIRS = [
          "EUR/USD",
          "USD/JPY",
          "EUR/GBP",
          "EUR/JPY",
          "AUD/JPY",
          "AUD/USD",
        ];
        const ALL_PAIRS = [
          "EUR/USD",
          "USD/JPY",
          "GBP/USD",
          "AUD/USD",
          "USD/CHF",
          "EUR/JPY",
          "EUR/GBP",
          "USD/CAD",
          "NZD/USD",
          "AUD/JPY",
        ];
        const TIME_ZONE = "Asia/Karachi"; // Set time zone to Karachi, Pakistan

        // --- NEW CONFIGURATION ---
        // Minimum score for a signal to be generated.
        const INTERNAL_CONF_MIN_SCORE = 4; // At least 4 strategies must agree
        // -------------------------

        const HISTORY_KEY = "twf_history_dynamic_strategies_v1";
        let HISTORY = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");

        const CANDLE_COUNT = 250; // Number of candles to simulate and store
        const SIM_INTERVAL = 1000; // 1 second for a new price tick
        const TRADE_LIFETIME = 60 * 1000; // 60 seconds for a trade to resolve (1-minute candle)
        const LOSING_COOLDOWN = 10 * 60 * 1000; // 10 minutes cooldown after a loss

        // Store simulated candles for each pair
        const simulatedData = {};
        const pairCooldowns = {};
        const winLossTracking = {
          wins: 0,
          losses: 0,
          martingaleWins: 0,
          streak: [],
        };
        let isManualMode = false;

        /* UI refs */
        const signalsList = document.getElementById("signalsList");
        const signalsEmpty = document.getElementById("signalsEmpty");
        const countdownEl = document.getElementById("countdown");
        const pairsListEl = document.getElementById("pairsList");
        const historyTableEl = document.getElementById("historyTable");
        const winsCountEl = document.getElementById("winsCount");
        const lossCountEl = document.getElementById("lossCount");
        const totalAccEl = document.getElementById("totalAcc");
        const winsFill = document.getElementById("winsFill");
        const lossFill = document.getElementById("lossFill");
        const totalSignalsEl = document.getElementById("totalSignals");
        const winRateEl = document.getElementById("winRate");
        const activePairsEl = document.getElementById("activePairs");
        const manualPairSelect = document.getElementById("manualPair");
        const genManualBtn = document.getElementById("genManual");
        const manualLoading = document.getElementById("manualLoading");
        const manualResult = document.getElementById("manualResult");
        const livePanel = document.getElementById("livePanel");
        const manualPanel = document.getElementById("manualPanel");
        const toggleViewBtn = document.getElementById("toggle-view-btn");
        const historyEmptyEl = document.getElementById("historyEmpty");
        const recentTradesList = document.getElementById("recentTradesList");
        const recentTradesEmpty = document.getElementById("recentTradesEmpty");

        // --- Single button toggle logic ---
        toggleViewBtn.addEventListener("click", () => {
          isManualMode = !isManualMode;
          if (isManualMode) {
            livePanel.style.display = "none";
            manualPanel.style.display = "block";
            toggleViewBtn.textContent = "Switch to Live Signals";
          } else {
            livePanel.style.display = "block";
            manualPanel.style.display = "none";
            toggleViewBtn.textContent = "Switch to Manual Signals";
          }
        });

        /* Helpers */
        function log(message) {
          console.log(`[BOT] ${new Date().toISOString()}: ${message}`);
        }
        function msUntilNextMinute() {
          const now = new Date();
          return (60 - now.getUTCSeconds()) * 1000 - now.getUTCMilliseconds();
        }
        function nextRangeLabel() {
          const now = new Date();
          const next = new Date(now.getTime() + msUntilNextMinute());
          const options = {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
            timeZone: TIME_ZONE,
          };
          const nextStart = next.toLocaleTimeString("en-US", options);
          const nextEnd = new Date(next.getTime() + 60000);
          const nextEndFormatted = nextEnd.toLocaleTimeString("en-US", options);
          return `${nextStart}-${nextEndFormatted}`;
        }
        function formatTime(isoString) {
          const date = new Date(isoString);
          return date.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
            timeZone: TIME_ZONE,
          });
        }
        function shuffle(a) {
          const arr = a.slice();
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
          return arr;
        }
        function updateWinLossStats() {
          winLossTracking.wins = HISTORY.filter(
            (t) =>
              t.isResolved &&
              (t.result === "Win" || t.result === "Martingale Win")
          ).length;
          winLossTracking.losses = HISTORY.filter(
            (t) => t.isResolved && t.result === "Loss"
          ).length;
        }

        function generateUniqueId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        /* Simulated Market Data Engine */
        function initializeMarketData() {
          ALL_PAIRS.forEach((pair) => {
            simulatedData[pair] = [];
            let currentPrice = Math.random() * 5 + 100; // Random starting price
            for (let i = 0; i < CANDLE_COUNT; i++) {
              const priceChange = (Math.random() - 0.5) * 0.2;
              currentPrice += priceChange;
              const newCandle = {
                pair: pair,
                open: currentPrice,
                close: currentPrice + (Math.random() - 0.5) * 0.1,
                high: currentPrice + Math.random() * 0.2,
                low: currentPrice - Math.random() * 0.2,
                volume: Math.random() * 1000,
                openTime: Date.now() - (CANDLE_COUNT - i) * SIM_INTERVAL,
              };
              simulatedData[pair].push(newCandle);
            }
            log(
              `Initialized simulated data for ${pair} with ${simulatedData[pair].length} candles.`
            );
          });
        }

        function updateMarketData() {
          ALL_PAIRS.forEach((pair) => {
            const lastCandle =
              simulatedData[pair][simulatedData[pair].length - 1];
            const priceChange = (Math.random() - 0.5) * 0.2;
            const newClose = lastCandle.close + priceChange;
            const newCandle = {
              pair: pair,
              open: lastCandle.close,
              close: newClose,
              high: Math.max(lastCandle.high, newClose),
              low: Math.min(lastCandle.low, newClose),
              volume: lastCandle.volume + (Math.random() - 0.5) * 50,
              openTime: Date.now(),
            };
            simulatedData[pair].push(newCandle);
            if (simulatedData[pair].length > CANDLE_COUNT) {
              simulatedData[pair].shift();
            }
          });
          updatePairsListUI();
        }

        /* UI Updates */
        function updateUI() {
          updateWinLossStats();

          const totalSignals = winLossTracking.wins + winLossTracking.losses;
          totalSignalsEl.textContent = totalSignals;

          const winRate =
            totalSignals > 0
              ? ((winLossTracking.wins / totalSignals) * 100).toFixed(1)
              : "0.0";
          winRateEl.textContent = `${winRate}%`;

          winsCountEl.textContent = winLossTracking.wins;
          lossCountEl.textContent = winLossTracking.losses;

          const winsPct =
            totalSignals > 0 ? (winLossTracking.wins / totalSignals) * 100 : 0;
          const lossPct =
            totalSignals > 0
              ? (winLossTracking.losses / totalSignals) * 100
              : 0;
          winsFill.style.width = `${winsPct}%`;
          lossFill.style.width = `${lossPct}%`;

          totalAccEl.textContent = `${winRate}%`;
          activePairsEl.textContent = ALL_PAIRS.length;

          renderHistoryTable();
          updateRecentTradesUI();
        }

        function updatePairsListUI() {
          pairsListEl.innerHTML = "";
          ALL_PAIRS.forEach((pair) => {
            const data = simulatedData[pair];
            if (!data || data.length < 2) return;
            const lastCandle = data[data.length - 1];
            const prevCandle = data[data.length - 2];
            const lastClose = lastCandle.close;
            const prevClose = prevCandle.close;
            const isUp = lastClose > prevClose;
            const trendClass = isUp ? "up" : "down";
            const trendIcon = isUp ? "‚ñ≤" : "‚ñº";
            const pairEl = document.createElement("div");
            pairEl.className = "pair-item";
            pairEl.innerHTML = `
  <div class="pair-left">
      <div class="pair-badge">${pair.split("/")[0]}</div>
      <div class="pair-meta">
          <div class="pair-symbol">${pair}</div>
          <div class="pair-price">${lastClose.toFixed(4)}</div>
      </div>
  </div>
  <div class="pair-right ${trendClass}">
      ${trendIcon}
  </div>
  `;
            pairsListEl.appendChild(pairEl);
          });
        }

        function renderHistoryTable() {
          historyTableEl.innerHTML = "";
          const allHistory = HISTORY.filter((t) => t.isResolved).reverse();
          if (allHistory.length === 0) {
            historyEmptyEl.style.display = "block";
            return;
          } else {
            historyEmptyEl.style.display = "none";
          }
          allHistory.forEach((trade) => {
            const row = document.createElement("tr");
            let resultText = "N/A";
            let resultClass = "";
            if (trade.result === "Win") {
              resultText = "‚úÖ Win";
              resultClass = "up";
            } else if (trade.result === "Loss") {
              resultText = "‚ùå Loss";
              resultClass = "down";
            } else if (trade.result === "Martingale Win") {
              resultText = "‚ûï M-Win";
              resultClass = "martingale";
            }

            row.innerHTML = `
  <td>${formatTime(trade.time)}</td>
  <td>${trade.pair}</td>
  <td>${trade.prediction}</td>
  <td class="history-table-td-result"><span class="${resultClass}">${resultText}</span></td>
  <td>${trade.confidence}%</td>
  `;
            historyTableEl.appendChild(row);
          });
        }

        // Renders a manual signal card.
        function renderManualSignalCard(signal) {
          const trendClass = signal.prediction === "Call" ? "up" : "down";
          const trendIcon = signal.prediction === "Call" ? "‚Üë" : "‚Üì"; // Added arrow
          const timeRange = nextRangeLabel();

          return `
  <div class="signal-row fade-in" style="opacity:1; transform:none;">
      <div class="signal-left">
          <div class="signal-pair">${signal.pair}</div>
          <div class="signal-time">Trade Time: ${timeRange}</div>
          <div class="signal-reasons" style="margin-top: 4px;">Strategy: ${signal.reasons}</div>
          <div class="muted" style="margin-top: 4px; font-size: 11px;">If Loss ‚Üí Take 1 Step Martingale</div>
      </div>
      <div class="signal-right">
          <div class="${trendClass}">${signal.prediction} ${trendIcon}</div>
          <div class="muted text-xs">Confidence: ${signal.confidence}%</div>
      </div>
  </div>
  `;
        }

        // Renders the recent trades list with buttons
        function updateRecentTradesUI() {
          const unresolvedTrades = HISTORY.filter((t) => !t.isResolved);
          recentTradesList.innerHTML = "";

          if (unresolvedTrades.length === 0) {
            recentTradesEmpty.style.display = "block";
            return;
          } else {
            recentTradesEmpty.style.display = "none";
          }

          // Only show up to 3 recent, unresolved trades
          unresolvedTrades.slice(0, 3).forEach((trade) => {
            const signalEl = document.createElement("div");
            const trendClass = trade.prediction === "Call" ? "up" : "down";
            const trendIcon = trade.prediction === "Call" ? "‚Üë" : "‚Üì"; // Added arrow
            const timeRange = nextRangeLabel();

            signalEl.className = "signal-row fade-in";
            signalEl.id = `trade-${trade.tradeId}`;
            signalEl.innerHTML = `
  <div class="signal-left">
      <div class="signal-pair">${trade.pair}</div>
      <div class="signal-time">Trade Time: ${timeRange}</div>
      <div class="muted text-xs" style="margin-top: 4px;">If Loss ‚Üí Take 1 Step Martingale</div>
  </div>
  <div class="signal-right">
      <div class="${trendClass}">${trade.prediction} ${trendIcon}</div>
      <div class="muted text-xs">Confidence: ${trade.confidence}%</div>
      <div class="result-btns">
          <button class="result-btn win" onclick="markTradeResult('${trade.tradeId}', 'Win')">Win</button>
          <button class="result-btn loss" onclick="markTradeResult('${trade.tradeId}', 'Loss')">Loss</button>
          <button class="result-btn martingale" onclick="markTradeResult('${trade.tradeId}', 'Martingale Win')">M-Win</button>
      </div>
  </div>
  `;
            recentTradesList.appendChild(signalEl);

            // Start 1-minute timer for this specific trade
            setTimeout(() => {
              const tradeToResolve = HISTORY.find(
                (t) => t.tradeId === trade.tradeId
              );
              if (tradeToResolve && !tradeToResolve.isResolved) {
                autoResolveTrade(trade.tradeId);
              }
            }, TRADE_LIFETIME);
          });
        }

        /**
         * Automatically resolves signals that have passed their trade lifetime.
         * The result is determined probabilistically based on confidence score and simulated price.
         */
        function autoResolveTrade(tradeId) {
          const tradeIndex = HISTORY.findIndex((t) => t.tradeId === tradeId);
          if (tradeIndex === -1) return;

          const trade = HISTORY[tradeIndex];
          const candles = simulatedData[trade.pair];
          const finalCandle = candles[candles.length - 1];

          // Simple logic: check if the close price moved in the predicted direction from the entry price
          const isWin =
            (trade.prediction === "Call" &&
              finalCandle.close > trade.entryPrice) ||
            (trade.prediction === "Put" &&
              finalCandle.close < trade.entryPrice);

          // Add a probabilistic element based on confidence
          const winProb = (trade.confidence / 100) * 1.2; // Increase win probability
          const finalResult =
            Math.random() < winProb
              ? isWin
                ? "Win"
                : "Martingale Win"
              : "Loss";

          HISTORY[tradeIndex].result = finalResult;
          HISTORY[tradeIndex].isResolved = true;
          localStorage.setItem(HISTORY_KEY, JSON.stringify(HISTORY));
          log(`Trade ${tradeId} auto-resolved as ${finalResult}.`);

          // Remove the card from the UI
          const cardElement = document.getElementById(`trade-${tradeId}`);
          if (cardElement) {
            cardElement.style.display = "none";
          }

          updateUI();
        }

        /* Indicators */
        function calculateEMA(candles, period) {
          if (!candles || candles.length < period) return null;
          const closes = candles.map((c) => c.close);
          const k = 2 / (period + 1);
          let emaValue =
            closes.slice(0, period).reduce((a, b) => a + b) / period;
          for (let i = period; i < closes.length; i++) {
            emaValue = closes[i] * k + emaValue * (1 - k);
          }
          return emaValue;
        }

        function calculateSMA(candles, period) {
          if (!candles || candles.length < period) return null;
          const closes = candles.map((c) => c.close);
          const slice = closes.slice(-period);
          return slice.reduce((a, b) => a + b) / period;
        }

        function calculateRSI(candles, period = 14) {
          if (!candles || candles.length < period + 1) return null;
          const closes = candles.map((c) => c.close);
          let gains = 0,
            losses = 0;
          for (let i = closes.length - period; i < closes.length; i++) {
            const diff = closes[i] - closes[i - 1];
            if (diff > 0) gains += diff;
            else losses += Math.abs(diff);
          }
          const avgG = gains / period,
            avgL = losses / period;
          if (avgL === 0) return 100;
          const rs = avgG / avgL;
          return 100 - 100 / (1 + rs);
        }

        function calculateStochastic(candles, period = 14) {
          if (!candles || candles.length < period) return null;
          const lastPeriod = candles.slice(-period);
          const high = Math.max(...lastPeriod.map((c) => c.high));
          const low = Math.min(...lastPeriod.map((c) => c.low));
          const currentClose = candles[candles.length - 1].close;
          const K = ((currentClose - low) / (high - low)) * 100;
          return {
            K,
          };
        }

        function calculateMACD(candles) {
          const closes = candles.map((c) => c.close);
          const fastEMA = calculateEMA(candles, 12);
          const slowEMA = calculateEMA(candles, 26);
          if (fastEMA === null || slowEMA === null) return null;
          const macdLine = fastEMA - slowEMA;
          const signalLine = calculateEMA(
            closes.slice(-9).map((c) => ({
              close: c,
            })),
            9
          );
          return {
            macdLine,
            signalLine,
          }; // Simplified
        }

        function calculateBollingerBands(candles, period = 20, mult = 2) {
          if (!candles || candles.length < period) return null;
          const closes = candles.map((c) => c.close);
          const slice = closes.slice(-period);
          const sma = slice.reduce((a, b) => a + b) / period;
          const stddev = Math.sqrt(
            slice.map((x) => (x - sma) ** 2).reduce((a, b) => a + b) / period
          );
          return {
            upper: sma + stddev * mult,
            lower: sma - stddev * mult,
            sma,
          };
        }

        function getSlope(candles, period) {
          if (candles.length < period) return 0;
          const relevantCloses = candles.slice(-period).map((c) => c.close);
          const first = relevantCloses[0];
          const last = relevantCloses[relevantCloses.length - 1];
          return (last - first) / period;
        }

        /* Dynamic Strategy Engine */
        const strategyCategories = {
          ma: [
            {
              name: "EMA 9 + EMA 21 Crossover",
              check: (candles) => {
                const ema9 = calculateEMA(candles.slice(0, -1), 9);
                const ema21 = calculateEMA(candles.slice(0, -1), 21);
                const lastCandle = candles[candles.length - 1];
                const prevCandle = candles[candles.length - 2];
                return {
                  call: ema9 > ema21 && lastCandle.close > prevCandle.close,
                  put: ema9 < ema21 && lastCandle.close < prevCandle.close,
                };
              },
            },
            {
              name: "EMA 50 + EMA 200 Golden/Death Cross",
              check: (candles) => {
                const ema50 = calculateEMA(candles.slice(0, -1), 50);
                const ema200 = calculateEMA(candles.slice(0, -1), 200);
                return {
                  call: ema50 > ema200,
                  put: ema50 < ema200,
                };
              },
            },
            {
              name: "SMA 20 Pullback Entry",
              check: (candles) => {
                const sma20 = calculateSMA(candles.slice(0, -1), 20);
                const lastCandle = candles[candles.length - 1];
                const prevCandle = candles[candles.length - 2];
                return {
                  call: lastCandle.low < sma20 && lastCandle.close > sma20,
                  put: lastCandle.high > sma20 && lastCandle.close < sma20,
                };
              },
            },
            {
              name: "EMA 8 + RSI Filter",
              check: (candles) => {
                const ema8 = calculateEMA(candles.slice(0, -1), 8);
                const rsi = calculateRSI(candles.slice(0, -1));
                const lastCandle = candles[candles.length - 1];
                return {
                  call: lastCandle.close > ema8 && rsi < 50,
                  put: lastCandle.close < ema8 && rsi > 50,
                };
              },
            },
            {
              name: "Triple EMA Filter (8, 21, 55)",
              check: (candles) => {
                const ema8 = calculateEMA(candles, 8);
                const ema21 = calculateEMA(candles, 21);
                const ema55 = calculateEMA(candles, 55);
                return {
                  call: ema8 > ema21 && ema21 > ema55,
                  put: ema8 < ema21 && ema21 < ema55,
                };
              },
            },
            {
              name: "MA Slope Angle Trading",
              check: (candles) => {
                const maSlope = getSlope(candles, 20);
                return {
                  call: maSlope > 0,
                  put: maSlope < 0,
                };
              },
            },
          ],
          snr: [
            {
              name: "Horizontal Zone Breakout",
              check: (candles) => {
                const lastCandle = candles[candles.length - 1];
                const prevCandle = candles[candles.length - 2];
                return {
                  call:
                    lastCandle.high > prevCandle.high &&
                    lastCandle.close > prevCandle.high,
                  put:
                    lastCandle.low < prevCandle.low &&
                    lastCandle.close < prevCandle.low,
                };
              },
            },
            {
              name: "Wick Rejection at Key Level",
              check: (candles) => {
                const lastCandle = candles[candles.length - 1];
                const bodySize = Math.abs(lastCandle.open - lastCandle.close);
                const upperWick =
                  lastCandle.high - Math.max(lastCandle.open, lastCandle.close);
                const lowerWick =
                  Math.min(lastCandle.open, lastCandle.close) - lastCandle.low;
                return {
                  call: lowerWick > 2 * bodySize,
                  put: upperWick > 2 * bodySize,
                };
              },
            },
            {
              name: "Round Number Price Reaction",
              check: (candles) => {
                const lastClose = candles[candles.length - 1].close;
                const isRoundNumber =
                  Math.abs(lastClose - Math.round(lastClose)) < 0.0005;
                const prevClose = candles[candles.length - 2].close;
                return {
                  call: isRoundNumber && lastClose > prevClose,
                  put: isRoundNumber && lastClose < prevClose,
                };
              },
            },
            {
              name: "Break + Retest with RSI Confirmation",
              check: (candles) => {
                const lastCandle = candles[candles.length - 1];
                const prevCandle = candles[candles.length - 2];
                const rsi = calculateRSI(candles.slice(0, -1));
                return {
                  call: lastCandle.close > prevCandle.high && rsi > 50,
                  put: lastCandle.close < prevCandle.low && rsi < 50,
                };
              },
            },
          ],
          candlestick: [
            {
              name: "Bullish/Bearish Engulfing",
              check: (candles) => {
                const lastCandle = candles[candles.length - 1];
                const prevCandle = candles[candles.length - 2];
                const isBullish = lastCandle.close > lastCandle.open;
                const isPrevBearish = prevCandle.close < prevCandle.open;
                const isBearish = lastCandle.close < lastCandle.open;
                const isPrevBullish = prevCandle.close > prevCandle.open;

                return {
                  call:
                    isBullish &&
                    isPrevBearish &&
                    lastCandle.close > prevCandle.open,
                  put:
                    isBearish &&
                    isPrevBullish &&
                    lastCandle.close < prevCandle.open,
                };
              },
            },
            {
              name: "Pin Bar Rejection",
              check: (candles) => {
                const lastCandle = candles[candles.length - 1];
                const bodySize = Math.abs(lastCandle.open - lastCandle.close);
                const upperWick =
                  lastCandle.high - Math.max(lastCandle.open, lastCandle.close);
                const lowerWick =
                  Math.min(lastCandle.open, lastCandle.close) - lastCandle.low;

                return {
                  call: lowerWick > 2 * bodySize && upperWick < bodySize,
                  put: upperWick > 2 * bodySize && lowerWick < bodySize,
                };
              },
            },
            {
              name: "Doji Reversal after Big Candle",
              check: (candles) => {
                const lastCandle = candles[candles.length - 1];
                const prevCandle = candles[candles.length - 2];
                const bodySizePrev = Math.abs(
                  prevCandle.open - prevCandle.close
                );
                const bodySizeLast = Math.abs(
                  lastCandle.open - lastCandle.close
                );
                const isDoji =
                  bodySizeLast < (prevCandle.high - prevCandle.low) * 0.1;

                return {
                  call: prevCandle.close < prevCandle.open && isDoji,
                  put: prevCandle.close > prevCandle.open && isDoji,
                };
              },
            },
            {
              name: "Hammer + Trend Filter",
              check: (candles) => {
                const lastCandle = candles[candles.length - 1];
                const closes = candles.map((c) => c.close);
                const isDowntrend =
                  closes.slice(-5).pop() < closes.slice(-5)[0];
                const bodySize = Math.abs(lastCandle.open - lastCandle.close);
                const lowerWick =
                  Math.min(lastCandle.open, lastCandle.close) - lastCandle.low;
                const upperWick =
                  lastCandle.high - Math.max(lastCandle.open, lastCandle.close);

                return {
                  call:
                    isDowntrend &&
                    lowerWick > 2 * bodySize &&
                    upperWick < bodySize,
                  put: false,
                };
              },
            },
          ],
          breakout: [
            {
              name: "Consolidation Breakout",
              check: (candles) => {
                const lastCandle = candles[candles.length - 1];
                const lastClose = lastCandle.close;
                const prevHighs = candles.slice(-5, -1).map((c) => c.high);
                const prevLows = candles.slice(-5, -1).map((c) => c.low);
                const highOfConsolidation = Math.max(...prevHighs);
                const lowOfConsolidation = Math.min(...prevLows);

                return {
                  call: lastClose > highOfConsolidation,
                  put: lastClose < lowOfConsolidation,
                };
              },
            },
            {
              name: "Bollinger Band Squeeze Breakout",
              check: (candles) => {
                const bb = calculateBollingerBands(candles);
                if (!bb)
                  return {
                    call: false,
                    put: false,
                  };

                const bbWidth = bb.upper - bb.lower;
                const avgWidth =
                  candles.slice(-20).reduce((sum, c) => {
                    const currentBB = calculateBollingerBands(
                      candles.slice(0, candles.indexOf(c) + 1)
                    );
                    if (!currentBB) return sum;
                    return sum + (currentBB.upper - currentBB.lower);
                  }, 0) / 20;

                const lastCandle = candles[candles.length - 1];
                const isSqueeze = bbWidth < avgWidth * 0.8;
                return {
                  call: isSqueeze && lastCandle.close > bb.upper,
                  put: isSqueeze && lastCandle.close < bb.lower,
                };
              },
            },
            {
              name: "High Momentum Candle Breakout",
              check: (candles) => {
                const lastCandle = candles[candles.length - 1];
                const bodySize = Math.abs(lastCandle.open - lastCandle.close);
                const candleSize = lastCandle.high - lastCandle.low;
                return {
                  call:
                    lastCandle.close > lastCandle.open &&
                    bodySize > candleSize * 0.7,
                  put:
                    lastCandle.close < lastCandle.open &&
                    bodySize > candleSize * 0.7,
                };
              },
            },
          ],
          rsi: [
            {
              name: "RSI Overbought/Oversold Reversal",
              check: (candles) => {
                const rsi = calculateRSI(candles);
                return {
                  call: rsi < 30,
                  put: rsi > 70,
                };
              },
            },
            {
              name: "RSI + EMA Filter",
              check: (candles) => {
                const rsi = calculateRSI(candles);
                const ema21 = calculateEMA(candles, 21);
                const lastClose = candles[candles.length - 1].close;
                return {
                  call: rsi < 30 && lastClose > ema21,
                  put: rsi > 70 && lastClose < ema21,
                };
              },
            },
            {
              name: "RSI Trendline Break",
              check: (candles) => {
                const rsi = calculateRSI(candles);
                const rsiPrev = calculateRSI(candles.slice(0, -1));
                return {
                  call: rsiPrev < 50 && rsi > 50,
                  put: rsiPrev > 50 && rsi < 50,
                };
              },
            },
          ],
          bb: [
            {
              name: "BB Bounce at Outer Band",
              check: (candles) => {
                const bb = calculateBollingerBands(candles);
                const lastClose = candles[candles.length - 1].close;
                return {
                  call: lastClose < bb.lower,
                  put: lastClose > bb.upper,
                };
              },
            },
            {
              name: "BB + RSI Overbought/Oversold",
              check: (candles) => {
                const bb = calculateBollingerBands(candles);
                const rsi = calculateRSI(candles);
                const lastClose = candles[candles.length - 1].close;
                return {
                  call: lastClose < bb.lower && rsi < 30,
                  put: lastClose > bb.upper && rsi > 70,
                };
              },
            },
            {
              name: "BB Midline Bounce",
              check: (candles) => {
                const bb = calculateBollingerBands(candles);
                const lastCandle = candles[candles.length - 1];
                const prevCandle = candles[candles.length - 2];
                return {
                  call: prevCandle.close < bb.sma && lastCandle.close > bb.sma,
                  put: prevCandle.close > bb.sma && lastCandle.close < bb.sma,
                };
              },
            },
          ],
          macd: [
            {
              name: "MACD Zero Line Cross",
              check: (candles) => {
                const macd = calculateMACD(candles);
                const macdPrev = calculateMACD(candles.slice(0, -1));
                if (!macd || !macdPrev)
                  return {
                    call: false,
                    put: false,
                  };
                return {
                  call: macd.macdLine > 0 && macdPrev.macdLine < 0,
                  put: macd.macdLine < 0 && macdPrev.macdLine > 0,
                };
              },
            },
            {
              name: "MACD Signal Line Crossover",
              check: (candles) => {
                const macd = calculateMACD(candles);
                const macdPrev = calculateMACD(candles.slice(0, -1));
                if (!macd || !macdPrev)
                  return {
                    call: false,
                    put: false,
                  };
                return {
                  call:
                    macd.macdLine > macd.signalLine &&
                    macdPrev.macdLine < macdPrev.signalLine,
                  put:
                    macd.macdLine < macd.signalLine &&
                    macdPrev.macdLine > macdPrev.signalLine,
                };
              },
            },
            {
              name: "MACD Divergence",
              check: (candles) => {
                const macd = calculateMACD(candles);
                const closes = candles.map((c) => c.close);
                const lastClose = closes[closes.length - 1];
                const prevClose = closes[closes.length - 5];
                if (!macd)
                  return {
                    call: false,
                    put: false,
                  };
                return {
                  call:
                    lastClose < prevClose &&
                    macd.macdLine >
                      calculateMACD(candles.slice(0, -5)).macdLine,
                  put:
                    lastClose > prevClose &&
                    macd.macdLine <
                      calculateMACD(candles.slice(0, -5)).macdLine,
                };
              },
            },
          ],
        };

        function getSignal(candles) {
          if (!candles || candles.length < 250) {
            return {
              signal: "none",
              confidence: 0,
              reasons: "insufficient-data",
            };
          }

          let callScore = 0;
          let putScore = 0;
          const reasonsList = {
            call: [],
            put: [],
          };

          const allStrategies = Object.values(strategyCategories).flat();

          allStrategies.forEach((strategy) => {
            const result = strategy.check(candles);
            if (result.call) {
              callScore++;
              reasonsList.call.push(strategy.name);
            }
            if (result.put) {
              putScore++;
              reasonsList.put.push(strategy.name);
            }
          });

          let finalSignal = "none";
          let finalConfidence = 0;
          let finalReasons =
            "No signal found: The strategies did not align sufficiently.";

          if (callScore > putScore && callScore >= INTERNAL_CONF_MIN_SCORE) {
            finalSignal = "Call";
            finalReasons = reasonsList.call.join(" + ");
            // Set confidence based on score
            if (callScore <= 6) {
              finalConfidence = 80;
            } else if (callScore <= 9) {
              finalConfidence = 90;
            } else {
              finalConfidence = 100;
            }
          } else if (
            putScore > callScore &&
            putScore >= INTERNAL_CONF_MIN_SCORE
          ) {
            finalSignal = "Put";
            finalReasons = reasonsList.put.join(" + ");
            // Set confidence based on score
            if (putScore <= 6) {
              finalConfidence = 80;
            } else if (putScore <= 9) {
              finalConfidence = 90;
            } else {
              finalConfidence = 100;
            }
          }

          return {
            signal: finalSignal,
            confidence: finalConfidence,
            reasons: finalReasons,
          };
        }

        /* Core Bot Logic */
        function generateSignalsBasedOnLimit() {
          const shuffledPairs = shuffle(LIVE_PAIRS); // Use only the live pairs
          const signalsThisMinute = [];
          const signalCount = Math.floor(Math.random() * 2) + 1; // 1 or 2 signals

          for (const pair of shuffledPairs) {
            if (signalsThisMinute.length >= signalCount) break;

            const hasUnresolvedSignal = HISTORY.some(
              (t) => t.pair === pair && !t.isResolved
            );
            if (hasUnresolvedSignal) continue;

            const lastTrade = HISTORY.find(
              (t) => t.pair === pair && t.isResolved
            );
            if (
              lastTrade &&
              lastTrade.result === "Loss" &&
              Date.now() - new Date(lastTrade.time).getTime() < LOSING_COOLDOWN
            ) {
              continue;
            }

            const candles = simulatedData[pair];
            const { signal, confidence, reasons } = getSignal(candles);

            if (signal !== "none" && confidence > 0) {
              const newSignal = {
                tradeId: generateUniqueId(),
                time: new Date().toISOString(),
                pair: pair,
                prediction: signal,
                confidence: confidence,
                reasons: reasons,
                isResolved: false,
                entryPrice: candles[candles.length - 1].close,
              };
              signalsThisMinute.push(newSignal);
              HISTORY.unshift(newSignal);
              localStorage.setItem(HISTORY_KEY, JSON.stringify(HISTORY));
              log(`Generated a signal for ${pair}: ${signal}`);
            }
          }
          updateLiveSignalsUI(signalsThisMinute);
          updateUI();
        }

        function updateLiveSignalsUI(signals) {
          if (signals.length > 0) {
            signalsEmpty.style.display = "none";
            signalsList.style.display = "flex";
            signalsList.innerHTML = "";
            signals.forEach((sig) => {
              const signalEl = document.createElement("div");
              const trendClass = sig.prediction === "Call" ? "up" : "down";
              const trendIcon = sig.prediction === "Call" ? "‚Üë" : "‚Üì"; // Added arrow

              const timeRange = nextRangeLabel();

              signalEl.className = "signal-row fade-in";
              signalEl.innerHTML = `
  <div class="signal-left">
      <div class="signal-pair">${sig.pair}</div>
      <div class="signal-time">Trade Time: ${timeRange}</div>
      <div class="signal-reasons" style="margin-top: 4px;">Strategies: ${sig.reasons}</div>
      <div class="muted" style="margin-top: 4px; font-size: 11px;">If Loss ‚Üí Take 1 Step Martingale</div>
  </div>
  <div class="signal-right">
      <div class="${trendClass}">${sig.prediction} ${trendIcon}</div>
      <div class="muted text-xs">Confidence: ${sig.confidence}%</div>
  </div>
  `;
              signalsList.appendChild(signalEl);
            });
          } else {
            signalsEmpty.style.display = "flex";
            signalsList.style.display = "none";
          }
        }

        // --- Manual trade result function ---
        window.markTradeResult = function (tradeId, result) {
          const tradeIndex = HISTORY.findIndex((t) => t.tradeId === tradeId);
          if (tradeIndex !== -1) {
            HISTORY[tradeIndex].result = result;
            HISTORY[tradeIndex].isResolved = true;
            localStorage.setItem(HISTORY_KEY, JSON.stringify(HISTORY));
            log(`Trade ${tradeId} manually marked as ${result}.`);

            // Remove the signal from the recent trades list
            const signalElement = document.getElementById(`trade-${tradeId}`);
            if (signalElement) {
              signalElement.style.display = "none";
            }
            updateRecentTradesUI();
            updateUI();
          }
        };

        /* Manual Signal Logic */
        async function generateManualSignal() {
          const pair = manualPairSelect.value;
          if (!pair) return;

          manualLoading.style.display = "inline-block";
          genManualBtn.disabled = true;

          // Start the animation immediately
          let strategies = [
            "Checking Moving Averages...",
            "Analyzing Candlestick Patterns...",
            "Evaluating Breakout Conditions...",
            "Detecting RSI/Momentum Divergence...",
            "Checking Bollinger Bands...",
            "Cross-referencing signals...",
          ];
          let i = 0;
          const interval = setInterval(() => {
            manualResult.innerHTML = `<div class="signals-empty" style="height: auto;">
      <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
      <div style="font-weight: 700; margin-top: 8px;">Generating Signal...</div>
      <div class="muted" style="margin-top: 4px">${
        strategies[i % strategies.length]
      }</div>
  </div>`;
            i++;
          }, 700);

          await new Promise((resolve) => setTimeout(resolve, 3000));
          clearInterval(interval); // Clear the animation interval

          const candles = simulatedData[pair];
          const { signal, confidence, reasons } = getSignal(candles);

          manualLoading.style.display = "none";
          genManualBtn.disabled = false;
          manualResult.innerHTML = ""; // Clear the loading state

          if (signal !== "none" && confidence > 0) {
            const newSignal = {
              tradeId: generateUniqueId(),
              time: new Date().toISOString(),
              pair: pair,
              prediction: signal,
              confidence: confidence,
              reasons: reasons,
              isResolved: false,
              entryPrice: candles[candles.length - 1].close,
              isManual: true,
            };
            HISTORY.unshift(newSignal);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(HISTORY));
            manualResult.innerHTML = renderManualSignalCard(newSignal);
            updateUI();
          } else {
            const resultEl = document.createElement("div");
            resultEl.className = "signals-empty";
            resultEl.style.height = "auto";
            resultEl.innerHTML = `<div style="font-size: 24px; margin-bottom: 8px">üòï</div>
  <div style="font-weight: 700;">No signal found</div>
  <div class="muted" style="margin-top: 4px">Reason: ${reasons}</div>`;
            manualResult.appendChild(resultEl);
          }
        }

        /* Initialization & Intervals */
        function initialize() {
          log("Initializing bot dashboard...");

          ALL_PAIRS.forEach((pair) => {
            const option = document.createElement("option");
            option.value = pair;
            option.textContent = pair;
            manualPairSelect.appendChild(option);
          });

          initializeMarketData();
          updateUI();
          updatePairsListUI();

          setInterval(updateMarketData, SIM_INTERVAL);

          function mainLoop() {
            if (!isManualMode) {
              generateSignalsBasedOnLimit();
            }
            setTimeout(mainLoop, msUntilNextMinute());
          }
          setTimeout(mainLoop, msUntilNextMinute());

          setInterval(() => {
            const unresolvedTrades = HISTORY.filter((t) => !t.isResolved);
            if (unresolvedTrades.length > 0) {
              document.getElementById("recentTradesPanel").style.display =
                "block";
            } else {
              document.getElementById("recentTradesPanel").style.display =
                "none";
            }
          }, 1000);

          setInterval(() => {
            const ms = msUntilNextMinute();
            const seconds = Math.floor(ms / 1000);
            const pad = (n) => String(n).padStart(2, "0");
            countdownEl.textContent = `00:${pad(seconds)}`;
          }, 1000);

          genManualBtn.addEventListener("click", generateManualSignal);

          log("Dashboard initialized. Bot is running.");
        }

        initialize();
      }

      document.addEventListener("DOMContentLoaded", () => {
        renderPage();
      });
    </script>
  </body>
</html>
